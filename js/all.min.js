function distance(t,e,n,i){return Math.sqrt((t-n)*(t-n)+(e-i)*(e-i))}function onLineSeg(t,e,n,i,a,s){return approxeq(distance(t,e,a,s)+distance(n,i,a,s),distance(t,e,n,i))}function normalVectorLine(t,e,n,i){return[-(i-e),n-t]}function normalVectorCircle(t,e,n,i){return[n-t,i-e]}function dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]}function mod(t,e){return(t%e+e)%e}function midpoint(t,e,n,i){return[(t+n)/2,(e+i)/2]}function magnitude(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))}function approxeq(t,e,n){return null==n&&(n=.001),Math.abs(t-e)<n}function dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]}function mirror(t,e,n,i,a,s){var r,o,h,c,a,s,l,y;return r=a-n,o=s-i,h=(r*r-o*o)/(r*r+o*o),c=2*r*o/(r*r+o*o),l=Math.round(h*(t-n)+c*(e-i)+n),y=Math.round(c*(t-n)-h*(e-i)+i),[l,y]}function quadraticFormula(t,e,n){return(-e-Math.sqrt(e*e-4*t*n))/(2*t)}function checkLineIntersection(t,e,n,i,a,s,r,o){var h,c,l,y,p,v={x:null,y:null};return h=(o-s)*(n-t)-(r-a)*(i-e),0==h?!1:(c=e-s,l=t-a,y=(r-a)*c-(o-s)*l,p=(n-t)*c-(i-e)*l,c=y/h,l=p/h,v.x=t+c*(n-t),v.y=e+c*(i-e),c>=0&&1>=c&&l>=0&&1>=l?v:!1)}function lineSegIntersection(t,e){return checkLineIntersection(t.x1,t.y1,t.x2,t.y2,e.x1,e.y1,e.x2,e.y2)}function circleLineIntersect(t,e,n,i,a,s,o){var h=n-t,c=i-e,l=h*h+c*c,y=2*(h*(t-a)+c*(e-s)),p=(t-a)*(t-a)+(e-s)*(e-s)-o*o,v=y*y-4*l*p,x=(-y+Math.sqrt(v))/(2*l),d=(-y-Math.sqrt(v))/(2*l);if(x=t+x*h,d=t+d*h,x||0==x){var u,g;if(n-t==0)u=Math.sqrt(r*r-Math.pow(t-a,2))+s,g=-Math.sqrt(r*r-Math.pow(t-a,2))+s;else{var f=(i-e)/(n-t);u=f*(x-t)+e,g=f*(d-t)+e}var m=distance(x,u,t,e),S=distance(d,g,t,e);return S>m?{x:x,y:u}:{x:d,y:g}}return!1}function isInRange(t,e,n){var t=mod(t,2*Math.PI),e=mod(e,2*Math.PI);return t>e?n>t||e>n:e>t?e>n&&n>t:n==e}function angleFromSegment(t,e,n,i){return mod(Math.atan2(i-e,n-t),2*Math.PI)}function refractedAngle(t,e,n,i,a){function s(t,e,n,i){return[-(i-e),n-t]}function r(t,e,n,i){return[n-t,i-e]}function o(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))}function h(t,e){return t[0]*e[0]+t[1]*e[1]}var c=[n.x2-n.x1,n.y2-n.y1];if("line"===i.type)var l=s(i.x1,i.y1,i.x2,i.y2);else if("arc"===i.type)var l=r(i.centerX,i.centerY,a[0],a[1]);var y=h(c,l),p=Math.acos(y/(o(c)*o(l))),v=y>0?p:Math.PI-p,x=Math.asin(t/e*Math.sin(v)),d=x-v;if(t>e&&(d*=-1),"line"===i.type)var u=angleFromSegment(i.x1,i.y1,i.x2,i.y2);else if("arc"===i.type)var g=a[0],f=a[1],m=s(g,f,g+l[0],f+l[1]),u=Math.atan2(-m[1],-m[0]);var S=mod(n.angle-u,2*Math.PI);return S>0&&S<Math.PI/2||S>3*Math.PI/2&&S<2*Math.PI?n.angle+d:n.angle-d}function refractedAngle2(t,e,n,i,a){function s(t,e,n,i){return[-(i-e),n-t]}function r(t,e,n,i){return[n-t,i-e]}function o(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))}function h(t,e){return t[0]*e[0]+t[1]*e[1]}var c=[n.x2-n.x1,n.y2-n.y1];if("line"===i.type)var l=s(i.x1,i.y1,i.x2,i.y2);else if("arc"===i.type)var l=r(i.centerX,i.centerY,a[0],a[1]);var y=h(c,l),p=Math.acos(y/(o(c)*o(l))),v=y>0?p:Math.PI-p,x=Math.asin(t/e*Math.sin(v)),d=x-v;if(d*=-1,t>e&&(d*=-1),"line"===i.type)var u=angleFromSegment(i.x1,i.y1,i.x2,i.y2);else if("arc"===i.type)var g=a[0],f=a[1],m=s(g,f,g+l[0],f+l[1]),u=Math.atan2(-m[1],-m[0]);var S=mod(n.angle-u,2*Math.PI);return S>0&&S<Math.PI/2||S>3*Math.PI/2&&S<2*Math.PI?n.angle+d:n.angle-d}function normalVector(t,e,n,i){return[-(i-e),n-t]}function dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]}function boxContains(t,e,n,i,a,s,r,o,h,c){for(var l=[[t,e],[n,i],[a,s],[r,o]],y=!1,p=0,v=l.length-1;p<l.length;v=p++){var x=l[p][0],d=l[p][1],u=l[v][0],g=l[v][1],f=d>c!=g>c&&(u-x)*(c-d)/(g-d)+x>h;f&&(y=!y)}return y}function test1(){var t=1,e=-10,n=-1e3,i=-1e3,a=1e3,s=1e3,r=new LineSegment(t,e,n,i,a,s),o=new Ray(0,0,-Math.PI/4);console.log(r.intersection(o))}function test2(){var t=new Ray(50,50,Math.atan(7/6)),e=new Box(59,63,1,"blue",10,20);console.log(e.intersection(t))}function CanvasState(t){this.canvas=t,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d");document.defaultView&&document.defaultView.getComputedStyle&&(this.stylePaddingLeft=parseInt(document.defaultView.getComputedStyle(t,null).paddingLeft,10)||0,this.stylePaddingTop=parseInt(document.defaultView.getComputedStyle(t,null).paddingTop,10)||0,this.styleBorderLeft=parseInt(document.defaultView.getComputedStyle(t,null).borderLeftWidth,10)||0,this.styleBorderTop=parseInt(document.defaultView.getComputedStyle(t,null).borderTopWidth,10)||0);var e=document.body.parentNode;this.htmlTop=e.offsetTop,this.htmlLeft=e.offsetLeft,this.valid=!1,this.opticalElements=[],this.dragging=!1,this.selection=null,this.dragoffx=0,this.dragoffy=0;var n=this;t.addEventListener("selectstart",function(t){return t.preventDefault(),!1},!1),t.addEventListener("mousedown",function(t){for(var e=n.getMouse(t),i=e.x,a=e.y,s=n.opticalElements,r=s.length,o=r-1;o>=0;o--)if(s[o].contains(i,a)&&(!s[o].wall||!playing)){var h=s[o];return keysDown?(n.mouseAngle=Math.atan2(a-h.y,i-h.x),n.rotating=!0):(n.dragoffx=i-h.x,n.dragoffy=a-h.y,n.dragging=!0),n.selection=h,n.last_angle=n.selection.rotation,void(n.valid=!1)}n.selection&&(n.selection=null,n.valid=!1)},!0),t.addEventListener("mousemove",function(t){if(n.dragging){var e=n.getMouse(t);n.selection.x=e.x-n.dragoffx,n.selection.y=e.y-n.dragoffy,n.valid=!1}else if(n.rotating){var e=n.getMouse(t),i=Math.atan2(e.y-n.selection.y,e.x-n.selection.x);n.selection.setRotation(n.last_angle+i-n.mouseAngle),n.valid=!1}else{for(var e=n.getMouse(t),a=e.x,s=e.y,r=n.opticalElements,o=r.length,h=o-1;h>=0;h--)if(r[h].contains(a,s)&&(!r[h].wall||!playing))return void(mouseOverObject=!0);mouseOverObject=!1}},!0),t.addEventListener("mouseup",function(t){n.dragging=!1,n.rotating=!1},!0),t.addEventListener("dblclick",function(t){var e=n.getMouse(t),i=new GlassBox(e.x-10,e.y-10,200,200,0);n.addShape(i)},!0),this.selectionColor="#660066",this.selectionWidth=2,requestAnimationFrame(this.draw.bind(this))}function getCoordinates(t,e){return t=t*w/canvas_width,e=e*h/canvas_height,{x:t,y:e}}function getScreenPosition(t,e){return t=t*canvas_width/w,e=e*canvas_height/h,{x:t,y:e}}function generateLevelFile(){if(!playing){for(var t,e=canvasState.opticalElements,n="",i=0;i<e.length;i+=1)t=e[i],n+=t.print();n+=canvasState.laser.print(),window.open().document.write(n)}}function startLevel(level){canvasState.clearElements(),canvasState.dragging=!1,canvasState.rotating=!1,eval(levels[level])}function default_load(){var t=new Wall(400,400,15,300,0);canvasState.addShape(t);var e=new PlanoConvexLens(100,200,0,1.5,100,0);canvasState.addShape(e);var n=new Laser(0,50,80,0,15);canvasState.setLaser(n)}function startPlaying(){c=document.getElementById("myCanvas"),ctx=c.getContext("2d");var t=window.innerWidth-10,e=window.innerHeight-10;t/e>aspect_ratio?t=e*aspect_ratio:e=t/aspect_ratio,ctx.canvas.width=t,ctx.canvas.height=e,canvasState=new CanvasState(document.getElementById("myCanvas")),default_load()}function startGame(){document.getElementById("myVideo").load();var t=document.getElementById("myVideo");t.onended=function(){this.remove(),startPlaying()}}Array.prototype.extend=function(t){t.forEach(function(t){this.push(t)},this)};var Ray=function(t,e,n){this.x=t,this.y=e,this.original_angle=n,this.intersectionLimit=50,this.reset()};Ray.prototype.addToPath=function(t,e){this.path.push([t,e])},Ray.prototype.reset=function(){this.x1=this.x,this.y1=this.y,this.angle=this.original_angle,this.path=[[this.x1,this.y1]],this.n=1,this.setEndpoints(),this.hittingWinWall=!1,this.hittingLoseWall=!1},Ray.prototype.setAngle=function(t){this.angle=mod(t,2*Math.PI)},Ray.prototype.setEndpoints=function(){for(var t,e,n=this.x1,i=this.y1,a=this.x1+Number.MAX_SAFE_INTEGER*Math.cos(this.angle),s=this.y1+Number.MAX_SAFE_INTEGER*Math.sin(this.angle),r=canvasState.getBoundaries(),o=0;4>o;o+=1)if(t=r[o],e=checkLineIntersection(n,i,a,s,t.x1,t.y1,t.x2,t.y2),e&&(!approxeq(e.x,n,.001)||!approxeq(e.y,i,.001)))return this.x2=Math.round(e.x),void(this.y2=Math.round(e.y))},Ray.prototype.drawPath=function(){ctx.strokeStyle="#e600e5",ctx.lineWidth=rayLineWidth,ctx.beginPath(),ctx.moveTo(this.path[0][0],this.path[0][1]);for(var t=1;t<this.path.length;t+=1)ctx.lineTo(this.path[t][0],this.path[t][1]),ctx.moveTo(this.path[t][0],this.path[t][1]);ctx.stroke()},Ray.prototype.getIntersection=function(t){for(var e,n=[],i=this,a=t.length,s=0;a>s;s+=1)e=t[s].intersection(i),!e||approxeq(e.x,i.x1,.01)&&approxeq(e.y,i.y1,.01)||n.push(e);if(n.length>0){for(var r,o,h=n[0],c=distance(h.x,h.y,i.x1,i.y1),s=0;s<n.length;s+=1)o=n[s],r=distance(o.x,o.y,i.x1,i.y1),c>r&&(h=o,c=r);return h}return!1},Ray.prototype.getReflectionAngle=function(t,e){var n=this,i=t.curve;if("arc"==i.type)var a=t.x,s=t.y,r=normalVectorLine(a,s,a+e[0],s+e[1]),o=mirror(n.x2,n.y2,a,s,a+r[0],s+r[1]);else var o=mirror(n.x2,n.y2,i.x1,i.y1,i.x2,i.y2);var h=o[0],c=o[1];return Math.atan2(c-t.y,h-t.x)},Ray.prototype.rayTrace=function(t,e){var n,i,a,s=this;this.reset();for(var r=0;r<this.intersectionLimit&&(n=this.getIntersection(t),n);r+=1){if(s.addToPath(n.x,n.y),a=n.curve,n.element.n<0)return"winwall"==n.element.type?this.hittingWinWall=!0:"losewall"==n.element.type&&(this.hittingLoseWall=!0),void s.drawPath();var o=[s.x2-s.x1,s.y2-s.y1],h=n.element.getNormVec(a,n.x,n.y),c=dotProduct(o,h)<0,l=c&&0!=n.element.n?n.element.n:1;i=refractedAngle(s.n,l,s,n.curve,[n.x,n.y]),void 0==i||isNaN(i)||0==n.element.n?i=this.getReflectionAngle(n,h):s.n=l,s.setAngle(i),s.x1=n.x,s.y1=n.y,s.setEndpoints()}for(var r=0;r<e.length;r+=1)if(n=e[r].intersection(s),n&&(!approxeq(n.x,s.x1,.01)||!approxeq(n.y,s.y1,.01))){s.addToPath(n.x,n.y);break}s.drawPath()};var Laser=function(t,e,n,i,a){this.x=t,this.y=e,this.h=n,this.rotation=i,this.numRays=a,this.rays=[];for(var s=n/a,r=0;r<this.numRays;r+=1)this.rays.push(new Ray(t-r*s*Math.sin(i),e+r*s*Math.cos(i),i))};Laser.prototype.shootLaser=function(t,e){for(var n=this.rays.length,i=0;n>i;i+=1)this.rays[i].rayTrace(t,e);for(var a=0,i=0;n>i;i+=1)if(this.rays[i].hittingWinWall)a+=1;else if(this.rays[i].hittingLoseWall)return{win:!1,lose:!0};return a==this.numRays?{win:!0,lose:!1}:{win:!1,lose:!1}};var mouseOverObject=!1,c=0;CanvasState.prototype.addShape=function(t){this.opticalElements.push(t),this.valid=!1},CanvasState.prototype.getOpticalElements=function(){return this.opticalElements},CanvasState.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)},CanvasState.prototype.draw=function(){if(keysDown&&mouseOverObject){var t=document.getElementsByTagName("body")[0];t.style.cursor="url('images/cursor.png') 9 10, auto"}else{var t=document.getElementsByTagName("body")[0];t.style.cursor="default"}if(!this.valid){c=1;var e=this.ctx,n=this.opticalElements;this.clear();for(var i=n.length,a=0;i>a;a++){n[a];n[a].draw(e)}if(null!=this.selection){var s=this.selection;s.highlight(e)}var r;if(this.laser)if(r=this.shootLaser(this.laser),r.win&&playing){var o=window.confirm("You Win!");o&&(curLevel+=1,curLevel=mod(curLevel,numLevels)),startLevel(curLevel)}else r.lose&&playing&&0!=c&&(alert("You Lose!"),startLevel(curLevel));this.valid=!0}requestAnimationFrame(this.draw.bind(this))},CanvasState.prototype.getMouse=function(t){var e,n,i=this.canvas,a=0,s=0;if(void 0!==i.offsetParent)do a+=i.offsetLeft,s+=i.offsetTop;while(i=i.offsetParent);return a+=this.stylePaddingLeft+this.styleBorderLeft+this.htmlLeft,s+=this.stylePaddingTop+this.styleBorderTop+this.htmlTop,e=t.pageX-a,n=t.pageY-s,{x:e,y:n}},CanvasState.prototype.getBoundaries=function(t){var e=[];return e.push(new LineSegment(0,0,this.width,0)),e.push(new LineSegment(0,0,0,this.height)),e.push(new LineSegment(this.width,0,this.width,this.height)),e.push(new LineSegment(0,this.height,this.width,this.height)),e},CanvasState.prototype.shootLaser=function(t){return t.shootLaser(this.opticalElements,this.getBoundaries())},CanvasState.prototype.clearElements=function(){this.opticalElements=[]},CanvasState.prototype.setLaser=function(t){this.laser=t};var LineSegment=function(t,e,n,i){this.x1=t,this.y1=e,this.x2=n,this.y2=i,this.type="line"};LineSegment.prototype.intersection=function(t){var e=checkLineIntersection(t.x1,t.y1,t.x2,t.y2,this.x1,this.y1,this.x2,this.y2);return e?{x:e.x,y:e.y,curve:this}:!1};var Arc=function(t,e,n,i,a){this.x=t,this.y=e,this.r=n,this.rotation=i,this.extent=a,this.type="arc",this.generateCenterOfCircle()};Arc.prototype.generateCenterOfCircle=function(){var t,e=this.r,n=2*e*Math.sin(this.extent/2),i=1,a=-2*e,s=n*n/4;t=quadraticFormula(i,a,s);var r=e-t/2;this.centerX=this.x+r*Math.sin(this.rotation),this.centerY=this.y-r*Math.cos(this.rotation),this.p1=this.r*Math.cos(this.rotation)+this.centerX,this.q1=this.r*Math.sin(this.rotation)+this.centerY,this.p2=this.r*Math.cos(this.rotation+this.extent)+this.centerX,this.q2=this.r*Math.sin(this.rotation+this.extent)+this.centerY},Arc.prototype.draw=function(t){this.generateCenterOfCircle(),t.beginPath(),t.arc(this.centerX,this.centerY,this.r,this.rotation,this.rotation+this.extent),t.stroke()},Arc.prototype.contains=function(t,e){var n=this.r*Math.cos(this.rotation)+this.centerX,i=this.r*Math.sin(this.rotation)+this.centerY,a=this.r*Math.cos(this.rotation+this.extent)+this.centerX,s=this.r*Math.sin(this.rotation+this.extent)+this.centerY;if(n===a)var r=Math.abs(t-this.centerX)>=Math.abs(n-this.centerX);else{var o=[t-n,e-i],h=[this.centerX-n,this.centerY-i],c=normalVector(n,i,a,s),l=dotProduct(o,c)>0,y=dotProduct(h,c)>=0;approxeq(y,0,.001)&&(y=0);var r=l!=y}var p=Math.pow(t-this.centerX,2)+Math.pow(e-this.centerY,2)<=Math.pow(this.r,2);return r&&p?!0:!1};var Element=function(t,e,n,i){this.x=t,this.y=e,this.rotation=n,this.n=i},Box=function(t,e,n,i,a,s,r,o){Element.apply(this,arguments),this.w=a,this.h=s,this.color1=r,this.color2=o,this.generateLineSegments()};Box.prototype.generateLineSegments=function(){this.x1=this.x+this.h*Math.sin(this.rotation)/2-this.w*Math.cos(this.rotation)/2,this.y1=this.y-this.h*Math.cos(this.rotation)/2-this.w*Math.sin(this.rotation)/2,this.x2=this.x1-this.h*Math.sin(this.rotation),this.y2=this.y1+this.h*Math.cos(this.rotation),this.x4=this.x1+this.w*Math.cos(this.rotation),this.y4=this.y1+this.w*Math.sin(this.rotation),this.x3=this.x4-this.h*Math.sin(this.rotation),this.y3=this.y4+this.h*Math.cos(this.rotation),this.lineSegments=[],this.lineSegments.push(new LineSegment(this.x1,this.y1,this.x2,this.y2)),this.lineSegments.push(new LineSegment(this.x2,this.y2,this.x3,this.y3)),this.lineSegments.push(new LineSegment(this.x3,this.y3,this.x4,this.y4)),this.lineSegments.push(new LineSegment(this.x4,this.y4,this.x1,this.y1))},Box.prototype.setRotation=function(t){this.rotation=mod(t,2*Math.PI)},Box.prototype.drawNormals=function(t){var e=t.strokeStyle;t.strokeStyle="green",t.beginPath();var n=midpoint(this.x1,this.y1,this.x2,this.y2),i=midpoint(this.x2,this.y2,this.x3,this.y3),a=midpoint(this.x3,this.y3,this.x4,this.y4),s=midpoint(this.x4,this.y4,this.x1,this.y1),r=normalVectorLine(this.x1,this.y1,this.x2,this.y2),o=normalVectorLine(this.x2,this.y2,this.x3,this.y3),h=normalVectorLine(this.x3,this.y3,this.x4,this.y4),c=normalVectorLine(this.x4,this.y4,this.x1,this.y1),l={};l.x1=n[0],l.y1=n[1],l.x2=n[0]+r[0],l.y2=n[1]+r[1];var y={};y.x1=i[0],y.y1=i[1],y.x2=i[0]+o[0],y.y2=i[1]+o[1];var p={};p.x1=a[0],p.y1=a[1],p.x2=a[0]+h[0],p.y2=a[1]+h[1];var v={};v.x1=s[0],v.y1=s[1],v.x2=s[0]+c[0],v.y2=s[1]+c[1];var x=[];x.push(l),x.push(y),x.push(p),x.push(v);for(var d,u=0;u<x.length;u+=1)d=x[u],t.moveTo(d.x1,d.y1),t.lineTo(d.x2,d.y2),t.stroke();t.strokeStyle=e},Box.prototype.draw=function(t){this.generateLineSegments(),this.centerX=this.x,this.centerY=this.y;var e=t.createLinearGradient(this.x,this.y,this.x,this.y+this.h);e.addColorStop(0,this.color1),e.addColorStop(1,this.color2),t.fillStyle=e,t.beginPath(),t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2),t.lineTo(this.x3,this.y3),t.lineTo(this.x4,this.y4),t.lineTo(this.x1,this.y1),t.fill()},Box.prototype.highlight=function(t){this.generateLineSegments(),t.strokeStyle="purple",t.lineWidth=1,t.beginPath(),t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2),t.lineTo(this.x3,this.y3),t.lineTo(this.x4,this.y4),t.lineTo(this.x1,this.y1),t.stroke()},Box.prototype.intersection=function(t){for(var e,n,i=[],a=0;4>a;a+=1)e=this.lineSegments[a],n=e.intersection(t),!n||approxeq(n.x,t.x1,.1)&&approxeq(n.y,t.y1,.1)||i.push(n);if(i.length){for(var s,r,o=i[0],h=distance(o.x,o.y,t.x1,t.y1),a=0;a<i.length;a+=1)r=i[a],s=distance(r.x,r.y,t.x1,t.y1),h>s&&(o=r,h=s);return o.element=this,o}return!1},Box.prototype.contains=function(t,e){for(var n=[[this.x1,this.y1],[this.x2,this.y2],[this.x3,this.y3],[this.x4,this.y4]],i=!1,a=0,s=n.length-1;a<n.length;s=a++){var r=n[a][0],o=n[a][1],h=n[s][0],c=n[s][1],l=o>e!=c>e&&(h-r)*(e-o)/(c-o)+r>t;l&&(i=!i)}return i},Box.prototype.getNormVec=function(t){return normalVectorLine(t.x1,t.y1,t.x2,t.y2)};var Mirror=function(t,e,n,i,a){Box.apply(this,[t,e,a,0,n,i,"#a3c2c2","#d1e0e0"])};Mirror.prototype=Box.prototype,Mirror.prototype.constructor=Mirror;var GlassBox=function(t,e,n,i,a){Box.apply(this,[t,e,a,1.33,n,i,"#33cccc","#ccffcc"])};GlassBox.prototype=Box.prototype,GlassBox.prototype.constructor=GlassBox;var Wall=function(t,e,n,i,a){Box.apply(this,[t,e,a,-1,n,i,"#1f2e2e","#1f2e2e"]),this.type="wall",this.wall=!0};Wall.prototype=Box.prototype,Wall.prototype.constructor=Wall;var WinWall=function(t,e,n,i,a){Box.apply(this,[t,e,a,-1,n,i,"#00cc00","#00cc00"]),this.type="winwall",this.wall=!0};WinWall.prototype=Box.prototype,WinWall.prototype.constructor=WinWall;var LoseWall=function(t,e,n,i,a){Box.apply(this,[t,e,a,-1,n,i,"#ff0000","#ff0000"]),this.type="losewall",this.wall=!0};LoseWall.prototype=Box.prototype,LoseWall.prototype.constructor=LoseWall;var PlanoConvexLens=function(t,e,n,i,a,s){Element.apply(this,arguments),this.r=a,this.w=s,this.color1="#33cccc",this.color2="#ccffcc",this.extent=Math.PI,this.rotation=n,this.arc=new Arc(t-this.w*Math.cos(n)/2,e+this.w*Math.sin(n)/2,a,n,this.extent+n),this.generateLineSegments(),this.recalculateCurves(),this.generateCenter(),this.draw(canvasState.ctx)};PlanoConvexLens.prototype.generateLineSegments=function(){var t=this.arc.p1,e=this.arc.q1,n=t+this.w*Math.sin(this.rotation-(Math.PI/2-this.extent/2)),i=e-this.w*Math.cos(this.rotation-(Math.PI/2-this.extent/2)),a=this.arc.p2,s=this.arc.q2,r=a+this.w*Math.sin(this.rotation-(Math.PI/2-this.extent/2)),o=s-this.w*Math.cos(this.rotation-(Math.PI/2-this.extent/2));this.lineSegments=[],this.lineSegments.push(new LineSegment(t,e,n,i)),this.lineSegments.push(new LineSegment(n,i,r,o)),this.lineSegments.push(new LineSegment(r,o,a,s))},PlanoConvexLens.prototype.recalculateCurves=function(){this.arc.x=this.x-this.w*Math.sin(this.rotation)/2,this.arc.y=this.y+this.w*Math.cos(this.rotation)/2},PlanoConvexLens.prototype.generateCenter=function(){this.arc.generateCenterOfCircle(),this.centerX=this.arc.centerX,this.centerY=this.arc.centerY},PlanoConvexLens.prototype.drawCenter=function(t){t.beginPath(),t.strokeStyle="black",t.arc(this.x,this.y,.5,0,2*Math.PI),t.stroke(),t.fill(),t.beginPath(),t.strokeStyle="blue",t.arc(this.arc.x,this.arc.y,.5,0,2*Math.PI),t.stroke(),t.fill()},PlanoConvexLens.prototype.draw=function(t){this.recalculateCurves(),this.generateCenter(),this.generateLineSegments();var e=t.createLinearGradient(this.x,this.y,this.x+this.r,this.y+this.r);e.addColorStop(0,this.color1),e.addColorStop(1,this.color2),t.fillStyle=e;var n=this.arc;t.beginPath(),t.arc(this.centerX,this.centerY,n.r,n.rotation,n.rotation+n.extent),t.fill(),this.drawCenter(t)},PlanoConvexLens.prototype.setRotation=function(t){this.rotation=mod(t,2*Math.PI),this.arc.rotation=this.rotation},PlanoConvexLens.prototype.contains=function(t,e){var n=this.lineSegments[0].x1,i=this.lineSegments[0].y1,a=this.lineSegments[0].x2,s=this.lineSegments[0].y2,r=this.lineSegments[2].x1,o=this.lineSegments[2].y1,h=this.lineSegments[2].x2,c=this.lineSegments[2].y2;return this.arc.contains(t,e)||boxContains(n,i,a,s,r,o,h,c,t,e)},PlanoConvexLens.prototype.highlight=function(t){t.strokeStyle="purple",t.lineWidth=1;var e=this.lineSegments[0];t.beginPath(),t.moveTo(e.x1,e.y1);for(var n=0;n<this.lineSegments.length;n+=1)e=this.lineSegments[n],t.lineTo(e.x2,e.y2);t.stroke(),this.arc.draw(t)},PlanoConvexLens.prototype.intersectionBox=function(t){for(var e,n,i=[],a=0;a<this.lineSegments.length;a+=1)e=this.lineSegments[a],n=e.intersection(t),!n||approxeq(n.x,t.x1,.1)&&approxeq(n.y,t.y1,.1)||i.push(n);if(i.length){for(var s,r,o=i[0],h=distance(o.x,o.y,t.x1,t.y1),a=0;a<i.length;a+=1)r=i[a],s=distance(r.x,r.y,t.x1,t.y1),h>s&&(o=r,h=s);return o.element=this,o}return!1},PlanoConvexLens.prototype.intersection=function(t){var e=this.intersectionBox(t),n=this.intersectionArc(t);return boxDist=distance(e.x,e.y,t.x1,t.y1),arcDist=distance(n.x,n.y,t.x1,t.y1),boxDist<.001&&(e=!1),arcDist<.001&&(n=!1),e===!1&&n===!1?!1:e===!1?n:n===!1?e:boxDist<arcDist?e:n},PlanoConvexLens.prototype.intersectionArc=function(t){var e=t.x1,n=t.x2,i=t.y1,a=t.y2,s=this.centerX,r=this.centerY,o=this.r,h=n-e,c=a-i,l=h*h+c*c,y=2*(h*(e-s)+c*(i-r)),p=(e-s)*(e-s)+(i-r)*(i-r)-o*o,v=y*y-4*l*p,x=(-y+Math.sqrt(v))/(2*l),d=(-y-Math.sqrt(v))/(2*l);if(x=e+x*h,d=e+d*h,x||0==x){var u,g;if(n-e==0)u=Math.sqrt(o*o-Math.pow(e-s,2))+r,g=-Math.sqrt(o*o-Math.pow(e-s,2))+r;else{var f=(a-i)/(n-e);u=f*(x-e)+i,g=f*(d-e)+i}var m,S,w=distance(x,u,e,i),L=distance(d,g,e,i),M={x:x,y:u,curve:this.arc,element:this},b={x:d,y:g,curve:this.arc,element:this};L>w||approxeq(d,t.x1,.1)&&approxeq(g,t.y1,.1)?(m=M,S=b):(m=b,S=M);var l=angleFromSegment(s,r,m.x,m.y);return isInRange(this.rotation,this.rotation+this.extent,l)&&onLineSeg(t.x1,t.y1,t.x2,t.y2,m.x,m.y)?m:(l=angleFromSegment(s,r,S.x,S.y),isInRange(this.rotation,this.rotation+this.extent,l)&&onLineSeg(t.x1,t.y1,t.x2,t.y2,S.x,S.y)?S:!1)}return!1},PlanoConvexLens.prototype.getNormVec=function(t,e,n){return"line"==t.type?normalVectorLine(t.x1,t.y1,t.x2,t.y2):normalVectorCircle(t.centerX,t.centerY,e,n)};var PlanoConcaveLens=function(t,e,n,i,a,s){this.x=t,this.y=e,this.r=a,this.color1="#33cccc",this.color2="#ccffcc",this.original_rotation=n,this.n=i,this.extent=Math.PI,this.d=s,this.w=.5*s,this.type="concave",this.rotation=this.original_rotation+(Math.PI/2-this.extent/2),this.arc=new Arc(t-s*Math.sin(this.rotation),e+s*Math.cos(this.rotation),a,this.rotation+Math.PI,this.extent),this.generateLineSegments(),this.recalculateCurves(),this.generateCenter(),this.draw(canvasState.ctx)};PlanoConcaveLens.prototype.print=function(){return"var pcc = new PlanoConcaveLens("+this.x+","+this.y+","+this.r+","+this.original_rotation+","+this.n+","+this.d+");canvasState.addShape(pcc);"},PlanoConcaveLens.prototype.generateLineSegments=function(){var t=this.arc.p1,e=this.arc.q1,n=t+this.w*Math.sin(this.rotation-(Math.PI/2-this.extent/2)),i=e-this.w*Math.cos(this.rotation-(Math.PI/2-this.extent/2)),a=this.arc.p2,s=this.arc.q2,r=a+this.w*Math.sin(this.rotation-(Math.PI/2-this.extent/2)),o=s-this.w*Math.cos(this.rotation-(Math.PI/2-this.extent/2));this.lineSegments=[],this.lineSegments.push(new LineSegment(t,e,n,i)),this.lineSegments.push(new LineSegment(n,i,r,o)),this.lineSegments.push(new LineSegment(r,o,a,s))},PlanoConcaveLens.prototype.recalculateCurves=function(){this.arc.x=this.x,this.arc.y=this.y},PlanoConcaveLens.prototype.generateCenter=function(){this.arc.generateCenterOfCircle(),this.centerX=this.arc.centerX,this.centerY=this.arc.centerY},PlanoConcaveLens.prototype.draw=function(t){this.recalculateCurves(),this.generateCenter(),this.generateLineSegments();var e=t.createLinearGradient(this.x,this.y,this.x+this.r,this.y+this.r);e.addColorStop(0,this.color1),e.addColorStop(1,this.color2),t.fillStyle=e;var n=this.arc;t.beginPath(),t.arc(this.centerX,this.centerY,n.r,n.rotation,n.rotation+n.extent),t.stroke();for(var i=this.lineSegments[2],a=this.lineSegments.length-1;a>=0;a-=1)i=this.lineSegments[a],t.lineTo(i.x1,i.y1),t.stroke();t.fill()},PlanoConcaveLens.prototype.setRotation=function(t){this.rotation=mod(t,2*Math.PI),this.arc.rotation=this.rotation+Math.PI},PlanoConcaveLens.prototype.contains=function(t,e){var n=this.lineSegments[0].x1,i=this.lineSegments[0].y1,a=this.lineSegments[0].x2,s=this.lineSegments[0].y2,r=this.lineSegments[2].x1,o=this.lineSegments[2].y1,h=this.lineSegments[2].x2,c=this.lineSegments[2].y2;return!this.arc.contains(t,e)&&boxContains(n,i,a,s,r,o,h,c,t,e)},PlanoConcaveLens.prototype.highlight=function(t){t.strokeStyle="purple",t.lineWidth=1;var e=this.lineSegments[0];t.moveTo(e.x1,e.y1);for(var n=0;n<this.lineSegments.length;n+=1)e=this.lineSegments[n],t.lineTo(e.x2,e.y2),t.stroke();this.arc.draw(t)},PlanoConcaveLens.prototype.intersectionBox=function(t){for(var e,n,i=[],a=0;a<this.lineSegments.length;a+=1)e=this.lineSegments[a],n=e.intersection(t),!n||approxeq(n.x,t.x1,.1)&&approxeq(n.y,t.y1,.1)||i.push(n);if(0==i.length)return!1;for(var s,r,o=i[0],h=distance(o.x,o.y,t.x1,t.y1),a=0;a<i.length;a+=1)r=i[a],s=distance(r.x,r.y,t.x1,t.y1),h>s&&(o=r,h=s);return o.element=this,o},PlanoConcaveLens.prototype.intersection=function(t){var e=this.intersectionBox(t),n=this.intersectionArc(t);return boxDist=distance(e.x,e.y,t.x1,t.y1),arcDist=distance(n.x,n.y,t.x1,t.y1),boxDist<.001&&(e=!1),arcDist<.001&&(n=!1),e===!1&&n===!1?!1:e===!1?n:n===!1?e:boxDist<arcDist?e:n},PlanoConcaveLens.prototype.intersectionArc=function(t){var e=t.x1,n=t.x2,i=t.y1,a=t.y2,s=this.centerX,r=this.centerY,o=this.r,h=n-e,c=a-i,l=h*h+c*c,y=2*(h*(e-s)+c*(i-r)),p=(e-s)*(e-s)+(i-r)*(i-r)-o*o,v=y*y-4*l*p,x=(-y+Math.sqrt(v))/(2*l),d=(-y-Math.sqrt(v))/(2*l);if(x=e+x*h,d=e+d*h,x||0==x){var u,g;if(n-e==0)u=Math.sqrt(o*o-Math.pow(e-s,2))+r,g=-Math.sqrt(o*o-Math.pow(e-s,2))+r;else{var f=(a-i)/(n-e);u=f*(x-e)+i,g=f*(d-e)+i}var m,S,w=distance(x,u,e,i),L=distance(d,g,e,i),M={x:x,y:u,curve:this.arc,element:this},b={x:d,y:g,curve:this.arc,element:this};if(L>w||approxeq(d,t.x1,.1)&&approxeq(g,t.y1,.1))m=M,S=b;else{if(approxeq(d,t.x1,.1)&&approxeq(g,t.y1,.1))return!1;m=b,S=M}var l=mod(angleFromSegment(s,r,m.x,m.y)+Math.PI,2*Math.PI);return isInRange(this.rotation,this.rotation+this.extent,l)&&onLineSeg(t.x1,t.y1,t.x2,t.y2,m.x,m.y)?m:(l=mod(angleFromSegment(s,r,S.x,S.y)+Math.PI,2*Math.PI),isInRange(this.rotation,this.rotation+this.extent,l)&&onLineSeg(t.x1,t.y1,t.x2,t.y2,S.x,S.y)?S:!1)}return!1},PlanoConcaveLens.prototype.getNormVec=function(t,e,n){var i;return"line"==t.type?normalVectorLine(t.x1,t.y1,t.x2,t.y2):(i=normalVectorCircle(t.centerX,t.centerY,e,n),[-i[0],-i[1]])};var w=12850,h=6470,ratio=w/h,canvas_width=1285,canvas_height=647,canvasState,mousePointer,rayLineWidth=3,keysDown=0,curLevel=0,numLevels=3;window.addEventListener("keydown",function(t){13==t.keyCode?generateLevelFile():t.shiftKey?keysDown+=1:t.keyCode>47&&t.keyCode<51&&startLevel(t.keyCode-48)},!0),window.addEventListener("keyup",function(t){keysDown>0&&(keysDown-=1)},!0),window.addEventListener("mousedown",function(t){var e=document.getElementById("myVideo");e&&(e.remove(),startPlaying())},!0);var level0="var b = new Box(298,187,15,80,0.07760492258740825,0,'#a3c2c2','#d1e0e0');canvasState.addShape(b);var b = new Box(481,210,15,80,2.654072175223533,0,'#a3c2c2','#d1e0e0');canvasState.addShape(b);var b = new Box(272,437,270,230,6.193728413012803,1.33,'#33cccc','#ccffcc');canvasState.addShape(b);var b = new Wall(895,348,15,300,0);canvasState.addShape(b);var b = new Wall(587,81,15,300,0);canvasState.addShape(b);var b = new Wall(590,409,15,300,0);canvasState.addShape(b);var b = new Wall(895,680,15,300,0);canvasState.addShape(b);var b = new Wall(998,113,15,300,0);canvasState.addShape(b);var b = new WinWall(1075,382,15,100,0);canvasState.addShape(b);var l = new Laser(0,200,70,5.890486225480862,1);canvasState.setLaser(l);",level1="var b = new Box(796,526,15,150,4.06609060451356,0,'#a3c2c2','#d1e0e0');canvasState.addShape(b);var b = new WinWall(9,515,15,35,0);canvasState.addShape(b);var b = new Wall(308,435,15,150,0);canvasState.addShape(b);var b = new Wall(308,595,15,150,0);canvasState.addShape(b);var b = new Wall(61,353,15,150,1.5707963267948966);canvasState.addShape(b);var b = new Wall(241,353,15,150,1.5707963267948966);canvasState.addShape(b);var b = new Wall(61,600,15,150,1.5707963267948966);canvasState.addShape(b);var b = new Wall(241,600,15,150,1.5707963267948966);canvasState.addShape(b);var b = new Box(453,301,15,150,2.502010470300501,0,'#a3c2c2','#d1e0e0');canvasState.addShape(b);var pcc = new PlanoConcaveLens(1028,421,100,0.1,1.5,120);canvasState.addShape(pcc);var pcv = new PlanoConvexLens(747,670,150,3.6716097343392304,1.5,50);canvasState.addShape(pcv);var l = new Laser(0,120,70,0,10);canvasState.setLaser(l);",level2="var b = new Box(185,469,15,250,5.492932526690764,0,'#a3c2c2','#d1e0e0');canvasState.addShape(b);var b = new WinWall(1076,530,15,250,4.709338659392787);canvasState.addShape(b);var b = new Wall(597,185,15,10,0);canvasState.addShape(b);var b = new Wall(596,132,15,10,0);canvasState.addShape(b);var b = new Wall(595,72,15,10,0);canvasState.addShape(b);var b = new Wall(597,205,15,10,0);canvasState.addShape(b);var b = new Wall(596,167,15,10,0);canvasState.addShape(b);var b = new Wall(596,150,15,10,0);canvasState.addShape(b);var b = new Wall(597,223,15,10,0);canvasState.addShape(b);var b = new Wall(596,114,15,10,0);canvasState.addShape(b);var b = new Wall(595,94,15,10,0);canvasState.addShape(b);var b = new Wall(902,424,15,350,0);canvasState.addShape(b);var b = new Wall(1071,590,15,350,1.5674842972683347);canvasState.addShape(b);var pcc = new PlanoConcaveLens(769,548,60,0.1,1.5,120);canvasState.addShape(pcc);var pcv = new PlanoConvexLens(1415,476,150,6.285375236212544,1.5,50);canvasState.addShape(pcv);var l = new Laser(0,120,70,0,10);canvasState.setLaser(l);",level3,playing=!1,levels={0:level0,1:level1,2:level2,3:level3},vid={},aspect_width=1285,aspect_height=647,aspect_ratio=aspect_width/aspect_height;
